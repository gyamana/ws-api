packages:
  yum:
    gcc-c++: []
    ruby-devel: []
    ruby: []
    openssl-devel: []
    kernel-devel: []
    libstdc++-devel: []
    make: []
  rubygems:
    eventmachine: []
    eventmachine-tail: []
    syslog_protocol: []
    em-resolv-replace: []
    remote_syslog: []

files:
  "/etc/rsyslog.conf":
    mode: "000644"
    owner: ec2-user
    group: ec2-user
    source: "https://s3-eu-west-1.amazonaws.com/spotz-temp-hosting/ami-scripts/rsyslog.conf"

  "/etc/remote_applog.yml":
    mode: "00644"
    owner: root
    group: root
    encoding: plain
    content: |
      files: 
      - /var/log/messages
      - /var/log/nginx/error.log
      - /var/log/nodejs/nodejs.log
      - /var/log/eb-activity.log
      - /var/log/eb-commandprocessor.log
      - /var/log/eb-cfn-init.log
      destination:
        host: logs2.papertrailapp.com
        port: 11892
        protocol: tls

  "/tmp/update-remote-log-hostname.sh":
    mode: "00555"
    owner: root
    group: root
    encoding: plain
    content: |
      #!/bin/bash
      logger_config="/etc/remote_applog.yml"
      appname=`{ "Ref" : "AWSEBEnvironmentName" }`
      instid=`wget -q -O - http://169.254.169.254/latest/meta-data/instance-id`
      myhostname=${appname}_${instid}
      if [ -f $logger_config ]; then
        # remove the current host entry
        sed -i "/hostname*/d" $logger_config
        
        # add the proper one
        sed -i "1i\
        hostname: $myhostname" $logger_config
      fi
      echo "\$LocalHostName	$myhostname" > /etc/rsyslog.d/hostname.conf
      hostname $myhostname
      echo $myhostname > /etc/hostname

  "/etc/init.d/remote_applog":
    mode: "00555"
    owner: root
    group: root
    encoding: plain
    content: |
      #!/bin/bash
      #
      # remote_syslog This shell script takes care of starting and stopping
      #               remote_syslog daemon
      #
      # chkconfig: - 58 74
      # description: papertrail/remote_syslog \
      #              https://github.com/papertrail/remote_syslog/blob/master/examples/remote_syslog.init.d
      
      ### BEGIN INIT INFO
      # Provides: remote_applog
      # Required-Start: $network $local_fs $remote_fs
      # Required-Stop: $network $local_fs $remote_fs
      # Should-Start: $syslog $named ntpdate
      # Should-Stop: $syslog $named
      # Short-Description: start and stop remote_errolog
      # Description: papertrail/remote_syslog
      #              https://github.com/papertrail/remote_syslog/blob/master/examples/remote_syslog.init.d
      ### END INIT INFO
      
      # Source function library.
      . /etc/init.d/functions
      
      # Source networking configuration.
      . /etc/sysconfig/network
          
      config="/etc/remote_applog.yml"
      pid_dir="/var/run"
      
      EXTRAOPTIONS=""
      
      pid_file="$pid_dir/remote_applog.pid"
      
      PATH=/sbin:/bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:/opt/elasticbeanstalk/lib/ruby/bin/
      
      RETVAL=0
      
      is_running(){
        [ -e $pid_file ]
      }
      
      start(){
          echo -n $"Starting $prog: "
          unset HOME MAIL USER USERNAME
          remote_syslog -c $config --tls --pid-file $pid_file "$EXTRAOPTIONS"
          RETVAL=$?
          echo
          return $RETVAL
      }
      
      stop(){
          echo -n $"Stopping $prog: "
          if (is_running); then
            kill `cat $pid_file`
            RETVAL=$?
            echo
            return $RETVAL
          else
            echo "$pid_file not found"
          fi
      }
      
      status(){
          echo -n $"Checking for $pid_file: "
      
          if (is_running); then
            echo "found"
          else
            echo "not found"
          fi
      }
      
      reload(){
          restart
      }
      
      restart(){
          stop
          start
      }
      
      condrestart(){
          is_running && restart
          return 0
      }
      
      
      # See how we were called.
      case "$1" in
          start)
        start
        ;;
          stop)
        stop
        ;;
          status)
        status
        ;;
          restart)
        restart
        ;;
          reload)
        reload
        ;;
          condrestart)
        condrestart
        ;;
          *)
        echo $"Usage: $0 {start|stop|status|restart|condrestart|reload}"
        RETVAL=1
      esac
      
      exit $RETVAL

  "/tmp/papertrail-watchdog":
    mode: "00555"
    owner: root
    group: root
    encoding: plain
    content: |
      #!/bin/bash
      netstat |grep papertrail > /dev/null 2>&1
      STATUS=$?

      if [ $STATUS == 1 ]; then
          echo Papertrail may be hung up...restarting
          /usr/bin/logger Papertrail may be hung up...restarting
          /sbin/service remote_applog restart
      else
          echo Papertrail looks to be running ok
          /usr/bin/logger Papertrail looks to be running ok
      fi

commands:
  00_update_config_file_and_hostname:
    command: ". /tmp/update-remote-log-hostname.sh"
  01_restart_system_logger:
    command: "service rsyslog restart"
  02_chmod_system_file:
    command: "chmod 755 /var/log/messages"
  03_enable_service:
    command: "/sbin/chkconfig remote_applog on"
  04_start_service:
    command: "/sbin/service remote_applog restart"
  05_remote_lock_file:
    command: "rm /var/run/syslogd.pid"
  06_add_cron_task:
    command: "mv -f /tmp/papertrail-watchdog /etc/cron.hourly/papertrail-watchdog"
